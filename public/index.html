<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منير رقم 1 - الخاص</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase Legacy SDKs for better compatibility with old code if needed, but keeping compat version -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #1a237e;
            --primary-light: #534bae;
            --primary-dark: #000051;
            --secondary-color: #ffd600;
            --accent-green: #2e7d32;
            --accent-red: #c62828;
            --bg-color: #f5f5f5;
            --white: #ffffff;
            --text-dark: #212121;
            --text-gray: #757575;
            --border-radius: 16px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-dark);
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 414px;
            height: 100vh;
            max-height: 896px;
            background-color: var(--bg-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }

        /* Splash Screen */
        #splash-screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--white);
            transition: opacity 0.5s ease-out;
        }
        .splash-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Login Screen */
        #login-screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--white);
            z-index: 9000;
            display: flex;
            flex-direction: column;
            padding: 40px 30px;
        }
        .login-header {
            text-align: center;
            margin-bottom: 50px;
            margin-top: 40px;
        }
        .login-header i {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .login-header h1 {
            font-size: 1.8rem;
            color: var(--primary-dark);
            font-weight: 700;
        }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-gray); }
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s;
            text-align: right;
            outline: none;
        }
        .form-input:focus { border-color: var(--primary-light); }
        .btn-login {
            width: 100%;
            padding: 16px;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            margin-top: 10px;
        }

        /* Main App Interface */
        .page {
            flex: 1;
            display: none;
            flex-direction: column;
            background-color: var(--bg-color);
            padding-bottom: 80px;
            overflow-y: auto;
        }
        .page.active { display: flex; }

        /* Dialer Styles */
        .dialer-header {
            padding: 30px 20px;
            background: var(--white);
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .balance-chip {
            display: inline-flex;
            align-items: center;
            background: #e8eaf6;
            color: var(--primary-color);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 20px;
            cursor: pointer;
        }
        .dial-number {
            font-size: 2.8rem;
            height: 60px;
            color: var(--text-dark);
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .keypad-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 30px 40px;
            align-content: center;
        }
        .key-btn {
            aspect-ratio: 1/1;
            background: var(--white);
            border: none;
            border-radius: 50%;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        .key-btn:active { transform: scale(0.92); background: #f0f0f0; }
        .key-sub { font-size: 0.7rem; color: var(--text-gray); margin-top: -5px; }
        
        .action-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            padding: 20px 0 40px 0;
        }
        .call-trigger {
            width: 80px;
            height: 80px;
            background-color: var(--accent-green);
            color: var(--white);
            border: none;
            border-radius: 50%;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px rgba(46,125,50,0.3);
            cursor: pointer;
        }
        .backspace-btn {
            font-size: 1.8rem;
            color: var(--text-gray);
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Nav Bar */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 75px;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #eee;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #bdbdbd;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.3s;
        }
        .nav-item.active { color: var(--primary-color); }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }

        /* Headers */
        .page-header {
            background: var(--primary-color);
            color: var(--white);
            padding: 20px;
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: var(--shadow-sm);
        }

        /* List Items */
        .list-container { padding: 15px; }
        .list-card {
            background: var(--white);
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }
        .list-info h4 { font-size: 1.1rem; color: var(--text-dark); margin-bottom: 4px; }
        .list-info p { font-size: 0.85rem; color: var(--text-gray); }
        .list-amount { font-weight: 700; color: var(--accent-red); }

        /* Wallet */
        .balance-card {
            background: linear-gradient(45deg, var(--primary-dark), var(--primary-light));
            margin: 20px;
            padding: 40px 20px;
            border-radius: 24px;
            color: var(--white);
            text-align: center;
            box-shadow: var(--shadow-md);
        }
        .balance-card p { opacity: 0.8; font-size: 1rem; }
        .balance-card h2 { font-size: 3rem; margin: 10px 0; font-weight: 800; }
        .topup-btn {
            background: var(--secondary-color);
            color: var(--primary-dark);
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1rem;
            margin-top: 15px;
            cursor: pointer;
        }

        /* Call Overlay */
        #call-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.92);
            z-index: 11000;
            color: var(--white);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 60px 20px;
        }
        .caller-info { text-align: center; }
        .caller-info h2 { font-size: 2.5rem; margin-bottom: 10px; }
        .call-status { font-size: 1.2rem; color: var(--secondary-color); font-weight: 600; }
        .call-timer { font-size: 3rem; font-weight: 200; margin-top: 20px; }
        .end-call-btn {
            width: 80px;
            height: 80px;
            background-color: var(--accent-red);
            color: var(--white);
            border: none;
            border-radius: 50%;
            font-size: 2.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(198,40,40,0.4);
            cursor: pointer;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Splash Screen -->
        <div id="splash-screen">
            <div class="splash-logo"><i class="fas fa-phone-alt"></i></div>
            <h1 style="font-size: 2.5rem; font-weight: 800; letter-spacing: 1px;">منير رقم 1</h1>
            <p style="margin-top: 10px; opacity: 0.7; font-weight: 600;">بوابتك للاتصال الخاص</p>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="hidden">
            <div class="login-header">
                <i class="fas fa-shield-alt"></i>
                <h1>تسجيل الدخول</h1>
                <p style="color: var(--text-gray); margin-top: 5px;">أدخل بياناتك للبدء</p>
            </div>
            <div class="form-group">
                <label class="form-label">البريد الإلكتروني</label>
                <input type="email" id="login-email" class="form-input" placeholder="example@mail.com">
            </div>
            <div class="form-group">
                <label class="form-label">كلمة المرور</label>
                <input type="password" id="login-pass" class="form-input" placeholder="••••••••">
            </div>
            <button class="btn-login" onclick="handleAuth('login')">دخول آمن</button>
            <p style="text-align: center; margin-top: 30px; font-size: 0.85rem; color: var(--text-gray);">بالمتابعة أنت توافق على شروط الخدمة</p>
        </div>

        <!-- Main Content -->
        <div id="main-app" class="hidden" style="flex: 1; display: flex; flex-direction: column;">
            <!-- Dialer -->
            <section id="page-dialer" class="page active">
                <div class="dialer-header">
                    <div class="balance-chip" onclick="switchTab('page-wallet', document.querySelector('[data-tab=wallet]'))">
                        <i class="fas fa-wallet" style="margin-left: 8px;"></i>
                        <span id="balance-val">$0.00</span>
                    </div>
                    <div class="dial-number" id="dial-display"></div>
                </div>
                <div class="keypad-container">
                    <button class="key-btn" onclick="dial('1')">1<span class="key-sub"> </span></button>
                    <button class="key-btn" onclick="dial('2')">2<span class="key-sub">ABC</span></button>
                    <button class="key-btn" onclick="dial('3')">3<span class="key-sub">DEF</span></button>
                    <button class="key-btn" onclick="dial('4')">4<span class="key-sub">GHI</span></button>
                    <button class="key-btn" onclick="dial('5')">5<span class="key-sub">JKL</span></button>
                    <button class="key-btn" onclick="dial('6')">6<span class="key-sub">MNO</span></button>
                    <button class="key-btn" onclick="dial('7')">7<span class="key-sub">PQRS</span></button>
                    <button class="key-btn" onclick="dial('8')">8<span class="key-sub">TUV</span></button>
                    <button class="key-btn" onclick="dial('9')">9<span class="key-sub">WXYZ</span></button>
                    <button class="key-btn" onclick="dial('*')">*<span class="key-sub"> </span></button>
                    <button class="key-btn" onclick="dial('0')">0<span class="key-sub">+</span></button>
                    <button class="key-btn" onclick="dial('#')">#<span class="key-sub"> </span></button>
                </div>
                <div class="action-row">
                    <div style="width: 40px;"></div> <!-- Spacer -->
                    <button class="call-trigger" onclick="makeCall()"><i class="fas fa-phone"></i></button>
                    <button class="backspace-btn" onclick="deleteDigit()"><i class="fas fa-backspace"></i></button>
                </div>
            </section>

            <!-- Recents -->
            <section id="page-recents" class="page">
                <div class="page-header">سجل المكالمات</div>
                <div class="list-container" id="recents-list"></div>
            </section>

            <!-- Wallet -->
            <section id="page-wallet" class="page">
                <div class="page-header">محفظتي</div>
                <div class="balance-card">
                    <p>الرصيد المتاح</p>
                    <h2 id="wallet-val">$0.00</h2>
                    <button class="topup-btn" onclick="alert('خدمة الشحن تتوفر قريباً عبر PayPal')">شحن الرصيد</button>
                </div>
            </section>

            <!-- Profile -->
            <section id="page-profile" class="page">
                <div class="page-header">حسابي</div>
                <div style="padding: 20px;">
                    <div class="list-card" style="margin-bottom: 20px;">
                        <div class="list-info">
                            <h4>رقم الحساب (UID)</h4>
                            <p id="profile-uid">---</p>
                        </div>
                        <i class="fas fa-id-card" style="color: var(--primary-color); font-size: 1.5rem;"></i>
                    </div>
                    <div class="list-card">
                        <div class="list-info">
                            <h4>إصدار التطبيق</h4>
                            <p>V 1.0.0</p>
                        </div>
                        <i class="fas fa-info-circle" style="color: var(--text-gray); font-size: 1.5rem;"></i>
                    </div>
                    <button class="btn-login" style="background: var(--accent-red); margin-top: 40px;" onclick="handleLogout()">تسجيل الخروج</button>
                </div>
            </section>

            <!-- Navigation -->
            <nav class="bottom-nav">
                <div class="nav-item active" onclick="switchTab('page-dialer', this)"><i class="fas fa-th"></i>لوحة</div>
                <div class="nav-item" onclick="switchTab('page-recents', this); loadHistory();"><i class="fas fa-history"></i>السجل</div>
                <div class="nav-item" data-tab="wallet" onclick="switchTab('page-wallet', this)"><i class="fas fa-wallet"></i>المحفظة</div>
                <div class="nav-item" onclick="switchTab('page-profile', this)"><i class="fas fa-user-circle"></i>حسابي</div>
            </nav>
        </div>

        <!-- Call Overlay -->
        <div id="call-overlay">
            <div class="caller-info">
                <h2 id="calling-num">...</h2>
                <p class="call-status" id="call-status">جاري الاتصال...</p>
                <div class="call-timer" id="call-timer">00:00</div>
            </div>
            <button class="end-call-btn" onclick="hangup()"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <script>
        // Real Firebase Config (Kept from previous turn)
        const firebaseConfig = { 
            apiKey: "GOOGLE_API_KEY", 
            authDomain: "call-now-24582.firebaseapp.com", 
            projectId: "call-now-24582", 
            databaseURL: "https://call-now-24582-default-rtdb.firebaseio.com/" 
        };
        firebase.initializeApp(firebaseConfig);

        let currentNumber = "";
        let callTimerInterval = null;
        let callSeconds = 0;

        // Splash screen handling
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.style.display = 'none';
                if(!localStorage.token) {
                    document.getElementById('login-screen').classList.remove('hidden');
                } else {
                    document.getElementById('main-app').classList.remove('hidden');
                    updateUserData();
                }
            }, 500);
        }, 2500);

        async function requestPermissions() {
            try {
                // Request Microphone
                await navigator.mediaDevices.getUserMedia({ audio: true });
                // Request Notifications
                if ('Notification' in window) await Notification.requestPermission();
                // Request Contacts (Contact Picker API)
                if ('contacts' in navigator && 'select' in navigator.contacts) {
                    console.log("Contacts API supported");
                }
                // Phone/Device info (Optional permissions handled by browser automatically on specific APIs)
            } catch (e) { console.warn("Some permissions were denied", e); }
        }

        async function handleAuth(type) {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            if(!email || !password) return alert("يرجى إدخال كافة البيانات");

            try {
                const res = await fetch(`/api/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if(data.ok) {
                    localStorage.token = data.token;
                    localStorage.uid = data.uid;
                    await requestPermissions();
                    location.reload();
                } else {
                    alert(data.error);
                }
            } catch(e) { alert("خطأ في الاتصال بالخادم"); }
        }

        function dial(k) { 
            if(currentNumber.length < 15) {
                currentNumber += k; 
                updateDisplay(); 
            }
        }
        function deleteDigit() { currentNumber = currentNumber.slice(0, -1); updateDisplay(); }
        function updateDisplay() { document.getElementById('dial-display').textContent = currentNumber; }

        function switchTab(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        async function updateUserData() {
            if(!localStorage.token) return;
            try {
                const res = await fetch('/api/user', {
                    headers: { 'Authorization': `Bearer ${localStorage.token}` }
                });
                const data = await res.json();
                if(data.ok) {
                    const bal = `$${data.user.balance.toFixed(2)}`;
                    document.getElementById('balance-val').innerText = bal;
                    document.getElementById('wallet-val').innerText = bal;
                    // Use UID as a fake US-like number format as requested
                    document.getElementById('profile-uid').innerText = "+1 (822) " + String(data.user.id).padStart(7, '0');
                } else {
                    handleLogout();
                }
            } catch(e) { console.error(e); }
        }

        async function loadHistory() {
            try {
                const res = await fetch('/api/history', {
                    headers: { 'Authorization': `Bearer ${localStorage.token}` }
                });
                const data = await res.json();
                if(data.ok) {
                    const list = document.getElementById('recents-list');
                    list.innerHTML = data.history.map(h => `
                        <div class="list-card">
                            <div class="list-info">
                                <h4>${h.toNumber}</h4>
                                <p>${new Date(h.timestamp).toLocaleString('ar-YE')}</p>
                            </div>
                            <div class="list-amount">-$${h.cost.toFixed(2)}</div>
                        </div>
                    `).join('') || '<p style="text-align:center; padding:40px; color:#999;">لا يوجد مكالمات سابقة</p>';
                }
            } catch(e) { console.error(e); }
        }

        async function makeCall() {
            if(!currentNumber) return alert("أدخل الرقم أولاً");
            try {
                const res = await fetch('/api/call', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.token}`
                    },
                    body: JSON.stringify({ to: currentNumber })
                });
                const data = await res.json();
                if(data.ok) {
                    document.getElementById('calling-num').innerText = currentNumber;
                    document.getElementById('call-overlay').style.display = 'flex';
                    document.getElementById('call-status').innerText = "جاري الاتصال...";
                    // Simulate waiting for 'connected' status from server/Twilio
                    setTimeout(() => {
                        document.getElementById('call-status').innerText = "متصل";
                        startTimer();
                    }, 2500);
                } else {
                    alert(data.error);
                }
            } catch(e) { alert("حدث خطأ تقني"); }
        }
        
        function startTimer() {
            callSeconds = 0;
            clearInterval(callTimerInterval);
            callTimerInterval = setInterval(() => {
                callSeconds++;
                const m = String(Math.floor(callSeconds / 60)).padStart(2, '0');
                const s = String(callSeconds % 60).padStart(2, '0');
                document.getElementById('call-timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        function hangup() {
            clearInterval(callTimerInterval);
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('call-timer').innerText = "00:00";
            currentNumber = "";
            updateDisplay();
            updateUserData();
        }

        function handleLogout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
